# Bitflow LMS - Master Entity-Relationship Diagram

**Version**: 2.0  
**Last Updated**: October 25, 2025  
**Database**: PostgreSQL 16

---

## Complete ER Diagram (ASCII Art)

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          BITFLOW LMS - DATABASE SCHEMA                               │
│                              38 TABLES | 6 SECTIONS                                  │
└─────────────────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════════════
                        SECTION 1: IDENTITY & ACCESS CONTROL
═══════════════════════════════════════════════════════════════════════════════════════

┌─────────────────────┐
│       users         │  PRIMARY IDENTITY TABLE
├─────────────────────┤
│ PK id (UUID)        │───┐
│    name             │   │
│    email (UNIQUE)   │   │
│    password         │   │
│    phone            │   │
│    university_id ───┼───┼────────────────────┐
│    is_active        │   │                    │
│    email_verified   │   │                    │
│    created_at       │   │                    │
└─────────────────────┘   │                    │
         │                │                    │
         │ 1              │                    │
         │                │ M                  │
         │ M              │                    │
    ┌────┴────┐      ┌────▼────────┐           │
    │         │      │             │           │
    │         │      │  sessions   │           │
┌───▼──────────────┐ ├─────────────┤           │
│   role_user      │ │ PK id       │           │
├──────────────────┤ │    user_id  │           │
│ FK user_id       │ │    token    │           │
│ FK role_id       │ │    ip       │           │
│    assigned_at   │ │    expires  │           │
└──────────────────┘ └─────────────┘           │
         │                                     │
         │ M                                   │
         │                                     │
         │ 1                                   │
┌────────▼──────────┐                          │
│      roles        │                          │
├───────────────────┤                          │
│ PK id (SERIAL)    │                          │
│    name           │                          │
│    slug (UNIQUE)  │                          │
│    level          │                          │
│    scope          │                          │
│    parent_id      │◄──┐ Self-referencing    │
└───────────────────┘   │                      │
         │              │                      │
         │ 1            │                      │
         │              │                      │
         │ M            │                      │
┌────────▼─────────────┐│                      │
│  role_permissions    ││                      │
├──────────────────────┤│                      │
│ FK role_id           ││                      │
│ FK permission_id     ││                      │
│    granted_at        ││                      │
└──────────────────────┘│                      │
         │               │                     │
         │ M             │                     │
         │               │                     │
         │ 1             │                     │
┌────────▼──────────────┐                      │
│    permissions        │                      │
├───────────────────────┤                      │
│ PK id (SERIAL)        │                      │
│    name               │                      │
│    slug (UNIQUE)      │                      │
│    resource           │                      │
│    action             │                      │
└───────────────────────┘                      │
                                               │
                                               │
═══════════════════════════════════════════════════════════════════════════════════════
                         SECTION 2: ORGANIZATIONAL STRUCTURE
═══════════════════════════════════════════════════════════════════════════════════════
                                               │
                                               │
┌──────────────────────┐                       │
│   universities       │ ROOT OF MULTI-TENANCY │
├──────────────────────┤                       │
│ PK id (UUID)         │◄──────────────────────┘
│    name              │
│    slug (UNIQUE)     │───┐
│    domain            │   │
│    email             │   │
│    phone             │   │
│    address           │   │
│    logo_url          │   │
│    is_active         │   │
│    storage_quota     │   │
│    created_at        │   │
└──────────────────────┘   │
         │                 │
         │ 1               │ 1
         │                 │
         │ M               │ M
┌────────▼──────────────┐  │  ┌──────────────────┐
│      colleges         │  │  │ academic_years   │
├───────────────────────┤  │  ├──────────────────┤
│ PK id (UUID)          │  │  │ PK id (UUID)     │
│ FK university_id      │──┘  │ FK university_id │
│    name               │     │    year          │
│    code (UNIQUE)      │     │    start_date    │
│    address            │     │    end_date      │
│    principal_user_id  │     │    is_current    │
│    is_active          │     └──────────────────┘
└───────────────────────┘
         │
         │ 1
         │
         │ M
┌────────▼──────────────┐
│     departments       │
├───────────────────────┤
│ PK id (UUID)          │
│ FK college_id         │
│    name               │
│    code (UNIQUE)      │
│    hod_faculty_id     │
└───────────────────────┘
         │
         │ 1
         │
         │ M
┌────────▼──────────────┐
│       courses         │
├───────────────────────┤
│ PK id (UUID)          │
│ FK department_id      │
│    code (UNIQUE)      │
│    name               │
│    description        │
│    credits            │
│    semester           │
│    syllabus_url       │
└───────────────────────┘


═══════════════════════════════════════════════════════════════════════════════════════
                             SECTION 3: ACADEMIC OPERATIONS
═══════════════════════════════════════════════════════════════════════════════════════

┌──────────────────────┐
│      students        │  CORE ACADEMIC ENTITY
├──────────────────────┤
│ PK id (UUID)         │
│ FK user_id (UNIQUE)  │──────────┐
│ FK college_id        │          │ References users table
│ FK department_id     │          │
│    roll_number       │          │
│    enrollment_year   │          │
│    current_semester  │          │
│    status            │          │
│    dob               │          │
│    gender            │          │
│    blood_group       │          │
│    address           │          │
│    guardian_name     │          │
│    guardian_phone    │          │
└──────────────────────┘
         │
         │ 1
         │
         ├──────────────┬──────────────┬─────────────┬────────────┐
         │ M            │ M            │ M           │ M          │ M
         │              │              │             │            │
┌────────▼────────┐ ┌───▼──────────┐ ┌▼───────────┐ ┌▼──────────┐ ┌▼─────────────┐
│   enrollments   │ │  attendance  │ │   grades   │ │submissions│ │ fee_payments │
├─────────────────┤ ├──────────────┤ ├────────────┤ ├───────────┤ ├──────────────┤
│ PK id (UUID)    │ │ PK id (UUID) │ │PK id (UUID)││PK id (UUID)││ PK id (UUID) │
│ FK student_id   │ │FK student_id │ │FK student  │││FK student │││ FK student   │
│ FK course_id    │ │FK course_id  │ │FK course   │││FK assign  │││ FK invoice   │
│ FK academic_yr  │ │   date       │ │   exam_type│││   file_url│││    amount    │
│    enrolled_at  │ │   status     │ │   marks    │││   grade   │││    paid_at   │
│    status       │ │   marked_by  │ │   graded_by│││   feedback│││    method    │
└─────────────────┘ │   marked_at  │ │   graded_at││└───────────┘││    status    │
         │          └──────────────┘ └────────────┘│             │└──────────────┘
         │                                         │             │
         │ M                                       │ M           │
         │                                         │             │
         │ 1                                       │ 1           │
┌────────▼──────────┐                     ┌────────▼──────────┐  │
│      courses      │                     │   assignments     │  │
│  (from above)     │                     ├───────────────────┤  │
└───────────────────┘                     │ PK id (UUID)      │  │
                                          │ FK course_id      │  │
                                          │    title          │  │
                                          │    description    │  │
                                          │    max_marks      │  │
                                          │    due_date       │  │
                                          │    file_url       │  │
                                          └───────────────────┘  │
                                                                 │
┌──────────────────────┐                                         │
│    timetables        │                                         │
├──────────────────────┤                                         │
│ PK id (UUID)         │                                         │
│ FK course_id         │                                         │
│ FK academic_year_id  │                                         │
│    name              │                                         │
│    effective_from    │                                         │
└──────────────────────┘                                         │
         │                                                       │
         │ 1                                                     │
         │                                                       │
         │ M                                                     │
┌────────▼──────────────┐                                        │
│   class_schedules     │                                        │
├───────────────────────┤                                        │
│ PK id (UUID)          │                                        │
│ FK timetable_id       │                                        │
│ FK faculty_id         │                                        │
│    day_of_week        │                                        │
│    start_time         │                                        │
│    end_time           │                                        │
│    room_number        │                                        │
└───────────────────────┘                                        │
                                                                 │
                                                                 │
═══════════════════════════════════════════════════════════════════════════════════════
                           SECTION 4: FACULTY & STAFF MANAGEMENT
═══════════════════════════════════════════════════════════════════════════════════════
                                                                 │
┌──────────────────────┐                                         │
│       faculty        │                                         │
├──────────────────────┤                                         │
│ PK id (UUID)         │                                         │
│ FK user_id (UNIQUE)  │──────────┐                             │
│ FK department_id     │          │ References users table      │
│    employee_id       │          │                             │
│    designation       │          │                             │
│    qualification     │          │                             │
│    specialization    │          │                             │
│    date_of_joining   │          │                             │
│    salary            │          │                             │
│    is_active         │          │                             │
└──────────────────────┘          │                             │
         │                        │                             │
         │ 1                      │                             │
         │                        │                             │
         │ M                      │                             │
┌────────▼──────────────┐         │                             │
│       leaves          │         │                             │
├───────────────────────┤         │                             │
│ PK id (UUID)          │         │                             │
│ FK faculty_id         │         │                             │
│    leave_type         │         │                             │
│    start_date         │         │                             │
│    end_date           │         │                             │
│    reason             │         │                             │
│    status             │         │                             │
│    approved_by        │         │                             │
│    approved_at        │         │                             │
└───────────────────────┘         │                             │
                                  │                             │
┌──────────────────────┐          │                             │
│        staff         │          │                             │
├──────────────────────┤          │                             │
│ PK id (UUID)         │          │                             │
│ FK user_id (UNIQUE)  │──────────┘                             │
│ FK college_id        │                                        │
│    employee_id       │                                        │
│    designation       │                                        │
│    department        │                                        │
│    date_of_joining   │                                        │
│    salary            │                                        │
│    is_active         │                                        │
└──────────────────────┘                                        │
         │                                                      │
         │ 1                                                    │
         │                                                      │
         │ M                                                    │
┌────────▼──────────────┐                                       │
│   payroll_records     │                                       │
├───────────────────────┤                                       │
│ PK id (UUID)          │                                       │
│ FK staff_id           │                                       │
│    month              │                                       │
│    year               │                                       │
│    basic_salary       │                                       │
│    allowances         │                                       │
│    deductions         │                                       │
│    net_salary         │                                       │
│    paid_on            │                                       │
└───────────────────────┘                                       │
                                                                │
                                                                │
═══════════════════════════════════════════════════════════════════════════════════════
                            SECTION 5: FINANCIAL MANAGEMENT
═══════════════════════════════════════════════════════════════════════════════════════
                                                                │
┌──────────────────────┐                                        │
│   fee_structures     │                                        │
├──────────────────────┤                                        │
│ PK id (UUID)         │                                        │
│ FK college_id        │                                        │
│ FK academic_year_id  │                                        │
│    fee_type          │                                        │
│    amount            │ (NUMERIC 10,2)                         │
│    semester          │                                        │
│    due_date          │                                        │
│    is_active         │                                        │
└──────────────────────┘                                        │
         │                                                      │
         │ 1                                                    │
         │                                                      │
         │ M                                                    │
┌────────▼──────────────┐                                       │
│      invoices        │                                        │
├──────────────────────┤                                        │
│ PK id (UUID)         │                                        │
│ FK student_id        │────────────────────────────────────────┘
│ FK fee_structure_id  │
│    invoice_number    │ (UNIQUE)
│    total_amount      │
│    paid_amount       │
│    balance           │
│    due_date          │
│    status            │
│    issued_at         │
└──────────────────────┘
         │
         │ 1
         │
         │ M
┌────────▼──────────────┐
│   fee_payments       │  (Already shown above with students)
│   (see above)        │
└──────────────────────┘

┌──────────────────────┐
│   ledger_entries     │  DOUBLE-ENTRY BOOKKEEPING
├──────────────────────┤
│ PK id (UUID)         │
│ FK university_id     │
│    transaction_id    │
│    account_type      │
│    debit             │
│    credit            │
│    description       │
│    reference_type    │
│    reference_id      │
│    created_at        │
└──────────────────────┘

┌──────────────────────┐
│  expense_categories  │
├──────────────────────┤
│ PK id (UUID)         │
│ FK university_id     │
│    name              │
│    code (UNIQUE)     │
│    description       │
└──────────────────────┘
         │
         │ 1
         │
         │ M
┌────────▼──────────────┐
│      expenses        │
├───────────────────────┤
│ PK id (UUID)          │
│ FK category_id        │
│ FK college_id         │
│    amount             │
│    description        │
│    expense_date       │
│    receipt_url        │
│    approved_by        │
│    approved_at        │
└───────────────────────┘

┌──────────────────────┐
│  payment_gateways    │
├──────────────────────┤
│ PK id (UUID)         │
│ FK university_id     │
│    name              │
│    provider          │
│    api_key_encrypted │
│    is_active         │
└──────────────────────┘


═══════════════════════════════════════════════════════════════════════════════════════
                          SECTION 6: OPERATIONS & COMMUNICATIONS
═══════════════════════════════════════════════════════════════════════════════════════

┌──────────────────────┐
│   notifications      │
├──────────────────────┤
│ PK id (UUID)         │
│ FK user_id           │
│    type              │
│    title             │
│    message           │
│    link              │
│    read_at           │
│    created_at        │
└──────────────────────┘

┌──────────────────────┐
│    audit_logs        │  COMPLETE AUDIT TRAIL
├──────────────────────┤
│ PK id (UUID)         │
│ FK user_id           │
│ FK university_id     │
│    action            │
│    entity_type       │
│    entity_id         │
│    changes (JSONB)   │
│    ip_address        │
│    user_agent        │
│    created_at        │
└──────────────────────┘

┌──────────────────────┐
│    file_uploads      │
├──────────────────────┤
│ PK id (UUID)         │
│ FK uploader_user_id  │
│ FK university_id     │
│    file_name         │
│    file_path         │
│    file_size         │
│    mime_type         │
│    uploaded_at       │
└──────────────────────┘

┌──────────────────────┐
│      settings        │
├──────────────────────┤
│ PK id (UUID)         │
│ FK university_id     │
│    key (UNIQUE)      │
│    value (JSONB)     │
│    updated_at        │
└──────────────────────┘

┌──────────────────────┐
│   announcements      │
├──────────────────────┤
│ PK id (UUID)         │
│ FK university_id     │
│ FK college_id        │
│    title             │
│    content           │
│    target_roles      │ (JSONB array)
│    published_at      │
│    expires_at        │
└──────────────────────┘

┌──────────────────────┐
│      messages        │
├──────────────────────┤
│ PK id (UUID)         │
│ FK sender_id         │
│ FK receiver_id       │
│    subject           │
│    body              │
│    read_at           │
│    sent_at           │
└──────────────────────┘

┌──────────────────────┐
│    parent_links      │
├──────────────────────┤
│ PK id (UUID)         │
│ FK parent_user_id    │
│ FK student_id        │
│    relationship      │
│    is_primary        │
│    created_at        │
└──────────────────────┘

┌──────────────────────┐
│  complaint_tickets   │
├──────────────────────┤
│ PK id (UUID)         │
│ FK created_by        │
│ FK assigned_to       │
│    ticket_number     │
│    category          │
│    subject           │
│    description       │
│    priority          │
│    status            │
│    resolved_at       │
│    created_at        │
└──────────────────────┘


═══════════════════════════════════════════════════════════════════════════════════════
                                  KEY RELATIONSHIPS
═══════════════════════════════════════════════════════════════════════════════════════

1. MULTI-TENANCY:
   - universities (1) ──> (M) users, colleges, academic_years, settings
   - ALL tenant-isolated tables have FK university_id with ON DELETE CASCADE

2. HIERARCHICAL STRUCTURE:
   - universities (1) ──> (M) colleges (1) ──> (M) departments (1) ──> (M) courses

3. ROLE-BASED ACCESS:
   - users (M) ◄──> (M) roles (through role_user pivot)
   - roles (M) ◄──> (M) permissions (through role_permissions pivot)

4. ACADEMIC FLOW:
   - students (1) ──> (M) enrollments (M) ◄── (1) courses
   - enrollments (1) ──> (M) attendance, grades, assignments

5. FINANCIAL FLOW:
   - fee_structures (1) ──> (M) invoices (1) ──> (M) fee_payments

6. POLYMORPHIC REFERENCES:
   - file_uploads: Can reference any entity via uploadable_type + uploadable_id
   - audit_logs: Tracks changes to any entity via entity_type + entity_id


═══════════════════════════════════════════════════════════════════════════════════════
                                    INDEXES & CONSTRAINTS
═══════════════════════════════════════════════════════════════════════════════════════

UNIQUE CONSTRAINTS:
- users.email
- universities.slug
- universities.domain
- colleges.code (within university)
- departments.code (within college)
- courses.code (within department)
- students.roll_number (within college)
- faculty.employee_id (within university)
- invoices.invoice_number (globally unique)

COMPOSITE INDEXES:
- (university_id, college_id) on students, faculty, staff
- (student_id, course_id) on enrollments
- (student_id, date) on attendance
- (user_id, created_at) on notifications
- (university_id, entity_type, created_at) on audit_logs

CHECK CONSTRAINTS:
- amount >= 0 on all financial tables
- start_date < end_date on leaves, academic_years
- credits > 0 on courses
- marks >= 0 AND marks <= 100 on grades


═══════════════════════════════════════════════════════════════════════════════════════
                                     TABLE COUNT: 38
═══════════════════════════════════════════════════════════════════════════════════════

Identity & Access (6):      users, roles, permissions, role_user, role_permissions, sessions
Structure (5):              universities, colleges, departments, courses, academic_years
Academic (8):               students, enrollments, attendance, grades, assignments, 
                           submissions, timetables, class_schedules
Faculty & Staff (4):        faculty, staff, leaves, payroll_records
Financial (7):              fee_structures, invoices, fee_payments, ledger_entries,
                           expense_categories, expenses, payment_gateways
Operations (4):             notifications, audit_logs, file_uploads, settings
Communications (4):         announcements, messages, parent_links, complaint_tickets


═══════════════════════════════════════════════════════════════════════════════════════
                                  END OF ER DIAGRAM
═══════════════════════════════════════════════════════════════════════════════════════
```

---

## Foreign Key Relationships Summary

```sql
-- IDENTITY & ACCESS
users.university_id → universities.id
role_user.user_id → users.id
role_user.role_id → roles.id
role_permissions.role_id → roles.id
role_permissions.permission_id → permissions.id
sessions.user_id → users.id
roles.parent_id → roles.id (self-referencing)

-- STRUCTURE
colleges.university_id → universities.id
departments.college_id → colleges.id
courses.department_id → departments.id
academic_years.university_id → universities.id

-- ACADEMIC
students.user_id → users.id
students.college_id → colleges.id
students.department_id → departments.id
enrollments.student_id → students.id
enrollments.course_id → courses.id
enrollments.academic_year_id → academic_years.id
attendance.student_id → students.id
attendance.course_id → courses.id
grades.student_id → students.id
grades.course_id → courses.id
assignments.course_id → courses.id
submissions.student_id → students.id
submissions.assignment_id → assignments.id
timetables.course_id → courses.id
timetables.academic_year_id → academic_years.id
class_schedules.timetable_id → timetables.id
class_schedules.faculty_id → faculty.id

-- FACULTY & STAFF
faculty.user_id → users.id
faculty.department_id → departments.id
staff.user_id → users.id
staff.college_id → colleges.id
leaves.faculty_id → faculty.id
payroll_records.staff_id → staff.id

-- FINANCIAL
fee_structures.college_id → colleges.id
fee_structures.academic_year_id → academic_years.id
invoices.student_id → students.id
invoices.fee_structure_id → fee_structures.id
fee_payments.student_id → students.id
fee_payments.invoice_id → invoices.id
ledger_entries.university_id → universities.id
expense_categories.university_id → universities.id
expenses.category_id → expense_categories.id
expenses.college_id → colleges.id
payment_gateways.university_id → universities.id

-- OPERATIONS & COMMUNICATIONS
notifications.user_id → users.id
audit_logs.user_id → users.id
audit_logs.university_id → universities.id
file_uploads.uploader_user_id → users.id
file_uploads.university_id → universities.id
settings.university_id → universities.id
announcements.university_id → universities.id
announcements.college_id → colleges.id (nullable)
messages.sender_id → users.id
messages.receiver_id → users.id
parent_links.parent_user_id → users.id
parent_links.student_id → students.id
complaint_tickets.created_by → users.id
complaint_tickets.assigned_to → users.id (nullable)
```

---

**📊 This ER diagram represents the complete database schema for Bitflow LMS with all 38 tables and their relationships.**
